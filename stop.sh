#!/bin/bash

#================================================================
# Kanban Local Server Stop Script
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ HTTP —Å–µ—Ä–≤–µ—Ä–∞
#================================================================

PORT=8000
PID_FILE="server.pid"

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."

# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ PID —Ñ–∞–π–ª—É
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ $PID..."
        kill $PID 2>/dev/null
        sleep 1

        # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
            kill -9 $PID 2>/dev/null
        fi

        echo "‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å $PID –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    rm -f "$PID_FILE"
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ª—é–±—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –Ω–µ–º
if lsof -ti:$PORT > /dev/null 2>&1; then
    echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É $PORT, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    lsof -ti:$PORT | xargs -r kill -9 2>/dev/null
    echo "‚úÖ –ü–æ—Ä—Ç $PORT –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω"
else
    echo "‚ÑπÔ∏è  –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

# –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥ —Ñ–∞–π–ª –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–±–æ–ª—å—à–µ 10MB)
if [ -f "server.log" ]; then
    LOG_SIZE=$(stat -f%z "server.log" 2>/dev/null || stat -c%s "server.log" 2>/dev/null)
    if [ "$LOG_SIZE" -gt 10485760 ]; then
        echo "üìù –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥ —Ñ–∞–π–ª–∞ (—Ä–∞–∑–º–µ—Ä > 10MB)..."
        > server.log
    fi
fi

echo ""
echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./start.sh"
