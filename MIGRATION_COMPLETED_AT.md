# Миграция: Установка completed_at для карточек в Done

## Проблема
Карточки в колонке Done не имеют даты завершения (`completed_at = null`), из-за чего массовое удаление по датам не работает.

## Решение
1. Обновлен код перемещения карточек - теперь при перемещении в Done автоматически устанавливается `completed_at`
2. Нужно применить SQL миграцию для существующих карточек

## Как применить миграцию

### Вариант 1: Через Supabase Dashboard (рекомендуется)

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в **SQL Editor** (слева в меню)
4. Создайте новый запрос
5. Скопируйте содержимое файла `migration_set_completed_at.sql` и вставьте в редактор
6. Нажмите **Run** (или Ctrl+Enter)
7. Проверьте результат - должны увидеть таблицу с обновленными карточками

### Вариант 2: Через командную строку

Если у вас настроен Supabase CLI:

```bash
supabase db execute < migration_set_completed_at.sql
```

### Вариант 3: Ручное обновление через интерфейс

Если миграция не применяется, карточки обновятся автоматически при следующем перемещении в/из Done.

## Что делает миграция

```sql
UPDATE cards
SET completed_at = updated_at
WHERE column_id = 'done'
  AND completed_at IS NULL;
```

Устанавливает `completed_at` равным `updated_at` для всех карточек в Done, у которых `completed_at` пустой.

## После применения

1. Обновите страницу канбана (Ctrl+F5)
2. Попробуйте массовое удаление снова
3. Проверьте в консоли браузера:
   ```javascript
   state.cards.find(c => c.column_id === 'done').completed_at
   ```
   Должна быть дата вместо `null`

## Изменения в коде

Файл: `js/services/cardService.js`
- Функция `moveCard()` теперь устанавливает `completed_at` при перемещении в Done
- При перемещении ИЗ Done очищает `completed_at`

## Проверка работы

После применения миграции и обновления страницы:

1. Откройте модальное окно массового удаления в Done
2. Выберите диапазон дат
3. Должно показать правильное количество карточек
4. Удаление должно работать корректно
